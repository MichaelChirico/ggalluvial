<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tooltips for ggalluvial plots in Shiny apps • ggalluvial</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Tooltips for ggalluvial plots in Shiny apps">
<meta property="og:description" content="ggalluvial">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ggalluvial</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.12.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/ggalluvial.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/labels.html">Labeling small strata</a>
    </li>
    <li>
      <a href="../articles/order-rectangles.html">The Order of the Rectangles</a>
    </li>
    <li>
      <a href="../articles/shiny.html">Tooltips for ggalluvial plots in Shiny apps</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/corybrunson/ggalluvial/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="shiny_files/header-attrs-2.5/header-attrs.js"></script><link href="shiny_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="shiny_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Tooltips for ggalluvial plots in Shiny apps</h1>
                        <h4 class="author">Quentin D. Read</h4>
            
            <h4 class="date">2020-12-04</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/corybrunson/ggalluvial/blob/master/vignettes/shiny.Rmd"><code>vignettes/shiny.Rmd</code></a></small>
      <div class="hidden name"><code>shiny.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">knitr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/knitr/man/opts_chunk.html">opts_chunk</a></span><span class="op">$</span><span class="fu">set</span><span class="op">(</span>fig.width <span class="op">=</span> <span class="fl">6</span>, fig.height <span class="op">=</span> <span class="fl">3</span>, fig.align <span class="op">=</span> <span class="st">"center"</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://corybrunson.github.io/ggalluvial/">ggalluvial</a></span><span class="op">)</span></code></pre></div>
<pre><code>## Loading required package: ggplot2</code></pre>
<div id="problem" class="section level2">
<h2 class="hasAnchor">
<a href="#problem" class="anchor"></a>Problem</h2>
<p>In an interactive visualization, it is visually cleaner and better for interpretation if labels and other information appear as “tooltips” when the user hovers over or clicks on elements of the plot, rather than displaying all the labels on the plot at one time. However, the <strong>ggalluvial</strong> package does not natively include this functionality. It is possible to enable this using functions from several other packages. This vignette illustrates a Shiny app that displays an alluvial plot with tooltips that appear when the user hovers over two different plot elements: strata created with <code><a href="../reference/geom_stratum.html">geom_stratum()</a></code> and alluvia created with <code><a href="../reference/geom_alluvium.html">geom_alluvium()</a></code>.</p>
<p>The tooltips that appear when the user hovers over elements of the plot show a text label and the number of flows included in each group. This is made relatively straightforward because if the user hovers or clicks somewhere inside a ggplot panel, Shiny automatically returns information about the location of the mouse cursor in plot coordinates. That means the main work we have to do is to extract or manually recalculate the coordinates of the different plot elements. With that information, we can determine which plot element the cursor is hovering over and display the appropriate information in the tooltip or other output method.</p>
<p><em>Note:</em> The app demonstrated here depends on the packages <strong>htmltools</strong> and <strong>sp</strong>, in addition of course to <strong>ggalluvial</strong> and <strong>shiny</strong>. Please be aware that all of these packages will need to be installed on the server where your Shiny app is running.</p>
<div id="hovering-over-and-clicking-on-strata" class="section level3">
<h3 class="hasAnchor">
<a href="#hovering-over-and-clicking-on-strata" class="anchor"></a>Hovering over and clicking on strata</h3>
<p>Enabling hovering over and clicking on strata is straightforward because of their rectangular shape. We only need the minimum and maximum <code>x</code> and <code>y</code> coordinates for each of the rectangles. The rectangles are evenly spaced along the x-axis, centered on positive integers beginning with 1. The width is set in <code><a href="../reference/geom_stratum.html">geom_stratum()</a></code> so, for example, we know that the x-coordinates of the first stratum are 1 ± <code>width</code>/2. The y-coordinates can be determined from the number of rows in the input data multiplied by their weights.</p>
</div>
<div id="hovering-over-and-clicking-on-alluvia" class="section level3">
<h3 class="hasAnchor">
<a href="#hovering-over-and-clicking-on-alluvia" class="anchor"></a>Hovering over and clicking on alluvia</h3>
<p>Hovering over and clicking on alluvia are more difficult because the shapes of the alluvia are more complex. The default shape of the polygons includes an <code>xspline</code> curve drawn using the <strong>grid</strong> package. We need to manually reconstruct the coordinates of the polygons, then use <code>sp::pointInPolygon()</code> to detect which, if any, polygons the cursor is over.</p>
</div>
</div>
<div id="data-for-reproducible-example" class="section level2">
<h2 class="hasAnchor">
<a href="#data-for-reproducible-example" class="anchor"></a>Data for reproducible example</h2>
<p>This toy dataset is used for the example app.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">example_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  weight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">12</span><span class="op">)</span>,
  ID <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">12</span>,
  cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span>,
  grp1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'1a'</span>, <span class="st">'1b'</span>, <span class="st">'1a'</span>, <span class="st">'1b'</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,
  grp2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'2a'</span>, <span class="st">'2b'</span>, <span class="st">'2a'</span>, <span class="st">'2b'</span>, <span class="st">'2a'</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,
  grp3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'3a'</span>,<span class="st">'3b'</span>, <span class="st">'3a'</span>, <span class="st">'3b'</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Here is a static plot generated using the toy dataset.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span><span class="va">example_data</span>,
       <span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">weight</span>, axis1 <span class="op">=</span> <span class="va">grp1</span>, axis2 <span class="op">=</span> <span class="va">grp2</span>, axis3 <span class="op">=</span> <span class="va">grp3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="../reference/geom_alluvium.html">geom_alluvium</a></span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span>, knot.pos <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="../reference/geom_stratum.html">geom_stratum</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">8</span>, reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_text</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="fu">after_stat</span><span class="op">(</span><span class="va">stratum</span><span class="op">)</span><span class="op">)</span>, 
            stat <span class="op">=</span> <span class="st">"stratum"</span>, 
            reverse <span class="op">=</span> <span class="cn">TRUE</span>, 
            size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_x_continuous</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="shiny_files/figure-html/static%20plot-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
<div id="structure-of-the-example-app" class="section level2">
<h2 class="hasAnchor">
<a href="#structure-of-the-example-app" class="anchor"></a>Structure of the example app</h2>
<p>Here, we will go over each section of the code in detail. The full code is reproduced at the bottom of this document.</p>
<div id="user-interface" class="section level3">
<h3 class="hasAnchor">
<a href="#user-interface" class="anchor"></a>User interface</h3>
<p>The app includes a minimal user interface with two output elements.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu">fluidPage</span><span class="op">(</span>
  <span class="fu">fluidRow</span><span class="op">(</span><span class="va">tags</span><span class="op">$</span><span class="fu">div</span><span class="op">(</span>
    style <span class="op">=</span> <span class="st">"position: relative;"</span>,
    <span class="fu">plotOutput</span><span class="op">(</span><span class="st">"alluvial_plot"</span>, height <span class="op">=</span> <span class="st">"500px"</span>, 
               hover <span class="op">=</span> <span class="fu">hoverOpts</span><span class="op">(</span>id <span class="op">=</span> <span class="st">"plot_hover"</span><span class="op">)</span>
               <span class="op">)</span>,
    <span class="fu">htmlOutput</span><span class="op">(</span><span class="st">"tooltip"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>The elements are:</p>
<ul>
<li>a <code>plotOutput</code> with the argument <code>hover</code> defined, to enable behavior determined by the cursor’s plot coordinates whenever the user hovers over the plot.</li>
<li>an <code>htmlOutput</code> for the tooltip that appears next to the cursor on hover.</li>
</ul>
<p>Both of the elements are wrapped in a <code><a href="https://shiny.rstudio.com/reference/shiny/latest/fluidPage.html">fluidRow()</a></code> and a <code><a href="https://rdrr.io/pkg/htmltools/man/builder.html">div()</a></code> tag.</p>
<p><em>Note:</em> This vignette only illustrates how to display output when the user hovers over an element. If you want to display output when the user clicks on an element, the corresponding argument to <code><a href="https://shiny.rstudio.com/reference/shiny/latest/plotOutput.html">plotOutput()</a></code> is <code>click = clickOpts(id = "plot_click")</code>. This will return the location of the mouse cursor in plot coordinates when the user clicks somewhere within the plot panel.</p>
</div>
<div id="server-function" class="section level3">
<h3 class="hasAnchor">
<a href="#server-function" class="anchor"></a>Server function</h3>
<p>The server function is more complex. Its general structure looks like this, in pseudocode:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="va">output</span><span class="op">$</span><span class="va">alluvial_plot</span> <span class="op">&lt;-</span> <span class="fu">renderPlot</span><span class="op">(</span><span class="op">{</span>
    
    <span class="st">'&lt;Create "ggplot" object for alluvial plot.&gt;'</span>
    
    <span class="st">'&lt;Build alluvial plot and assign globally.&gt;'</span>
    
    <span class="st">'&lt;Extract data from built plot object used to create alluvium polygons.&gt;'</span>
    
    <span class="st">'&lt;Use polygon splines to generate coordinates of alluvium boundaries.&gt;'</span>
    
    <span class="st">'&lt;Convert coordinates from grid units to plot units and assign globally.&gt;'</span>
    
    <span class="st">'&lt;Render the plot.&gt;'</span>
  <span class="op">}</span><span class="op">)</span>
  
  <span class="va">output</span><span class="op">$</span><span class="va">tooltip</span> <span class="op">&lt;-</span> <span class="fu">renderText</span><span class="op">(</span><span class="op">{</span>
    <span class="kw">if</span> <span class="op">(</span><span class="st">'&lt;mouse cursor is within the plot panel&gt;'</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw">if</span> <span class="op">(</span><span class="st">'&lt;mouse cursor is within a stratum box&gt;'</span><span class="op">)</span> <span class="op">{</span>
        <span class="st">'&lt;Render stratum tooltip.&gt;'</span>
      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
        <span class="kw">if</span> <span class="op">(</span><span class="st">'&lt;mouse cursor is within an alluvium polygon&gt;'</span><span class="op">)</span> <span class="op">{</span>
          <span class="st">'&lt;Render alluvium tooltip.&gt;'</span>
        <span class="op">}</span>
      <span class="op">}</span>
    <span class="op">}</span>
  <span class="op">}</span><span class="op">)</span>
  
<span class="op">}</span></code></pre></div>
<p>First, we create the <code>ggplot</code> object for the alluvial plot, then we call the <code>ggplot_build()</code> function to build the plot without displaying it. The next lines of code are to “reverse engineer” the polygon coordinates. Finally, we call <code><a href="https://shiny.rstudio.com/reference/shiny/latest/renderPlot.html">renderPlot()</a></code> to pass the plot to <code>output</code>.</p>
<p>Next, we define the tooltip with a <code><a href="https://shiny.rstudio.com/reference/shiny/latest/renderText.html">renderText()</a></code> expression. Within that expression, we first extract the cursor’s plot coordinates from the user input. We determine whether the cursor is hovering over a stratum and if so, display the appropriate tooltip.</p>
<div class="figure">
<img src="https://raw.githubusercontent.com/corybrunson/ggalluvial/main/vignettes/img/hover_stratum.jpg" alt=""><p class="caption">screenshot of tooltip on stratum</p>
</div>
<p>If the mouse cursor is not hovering over a stratum, we determine whether it is hovering over an alluvium polygon and if so, display different information in the tooltip.</p>
<div class="figure">
<img src="https://raw.githubusercontent.com/corybrunson/ggalluvial/main/vignettes/img/hover_alluvium.jpg" alt=""><p class="caption">screenshot of tooltip on alluvium</p>
</div>
<p>If the mouse cursor is hovering over an empty region of the plot, nothing is returned by <code><a href="https://shiny.rstudio.com/reference/shiny/latest/renderText.html">renderText()</a></code> and so no tooltip text box is displayed.</p>
<div class="figure">
<img src="https://raw.githubusercontent.com/corybrunson/ggalluvial/main/vignettes/img/hover_empty_area.jpg" alt=""><p class="caption">screenshot of cursor over empty region</p>
</div>
<p>Let’s take a deeper dive into each part of the server function.</p>
<div id="drawing-plot-and-extracting-coordinates" class="section level4">
<h4 class="hasAnchor">
<a href="#drawing-plot-and-extracting-coordinates" class="anchor"></a>1. Drawing plot and extracting coordinates</h4>
<p>The first part of the server function includes code to draw the plot and build it with <code>ggplot_build()</code>. Note that the global assignment operator <code><a href="https://rdrr.io/r/base/assignOps.html">&lt;&lt;-</a></code> is used to assign <code>node_width</code> and <code>pbuilt</code> so they are both accessible outside the <code><a href="https://shiny.rstudio.com/reference/shiny/latest/renderPlot.html">renderPlot()</a></code> expression.</p>
<p><em>Note:</em> In the example presented here, strictly speaking all of the plot drawing and coordinate extracting code could be outside the <code>server()</code> function, because the plot itself does not change with user input. However if you are building an app where the plot changes in response to user input, for example a menu of options of which variables to display, the plot drawing code has to be inside the <code><a href="https://shiny.rstudio.com/reference/shiny/latest/renderPlot.html">renderPlot()</a></code> expression. So we’ve left it there in the example code.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>output<span class="sc">$</span>alluvial_plot <span class="ot">&lt;-</span> <span class="fu">renderPlot</span>({</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Width of node boxes</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  node_width <span class="ot">&lt;&lt;-</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(example_data,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">y =</span> weight, <span class="at">axis1 =</span> grp1, <span class="at">axis2 =</span> grp2, <span class="at">axis3 =</span> grp3)) <span class="sc">+</span> </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_alluvium</span>(<span class="fu">aes</span>(<span class="at">fill =</span> <span class="fu">factor</span>(cluster)), <span class="at">knot.pos =</span> <span class="fl">0.25</span>) <span class="sc">+</span> </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_stratum</span>(<span class="at">width =</span> node_width, <span class="at">reverse =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">after_stat</span>(stratum)), </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>              <span class="at">stat =</span> <span class="st">"stratum"</span>, </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">reverse =</span> <span class="cn">TRUE</span>, </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="fu">rel</span>(<span class="dv">3</span>)) <span class="sc">+</span> </span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Build the plot. Use global assignment so that this object is accessible</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># later.</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  pbuilt <span class="ot">&lt;&lt;-</span> <span class="fu">ggplot_build</span>(p)</span></code></pre></div>
<p>Now for the hard part: reverse-engineering the coordinates of the alluvia polygons. This makes use of <code>pbuilt$data[[1]]</code>, a data frame with the individual elements of the alluvial plot. We add an additional column for <code>width</code>, which has a value of 1/3 hard-coded into <code><a href="../reference/geom_alluvium.html">ggalluvial::geom_alluvium()</a></code>, then split the data frame by group (groups correspond to the individual alluvium polygons). We apply the unexported function <code>ggalluvial:::data_to_xspline()</code> to each element of the list to get the x-spline coordinates. Then, we pass the x-spline coordinates to the function <code><a href="https://rdrr.io/r/grid/grid.xspline.html">grid::xsplineGrob()</a></code> to convert them into a <code>grid</code> object. We pass the resulting object to <code><a href="https://rdrr.io/r/grid/xsplinePoints.html">grid::xsplinePoints()</a></code>. At this point we now have the coordinates of the alluvium polygons.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R">  <span class="co"># Use built plot data to recalculate the locations of the flow polygons:</span>
    
  <span class="co"># Add width parameter, and then convert built plot data to xsplines</span>
  <span class="va">data_draw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html">transform</a></span><span class="op">(</span><span class="va">pbuilt</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, width <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span>
  <span class="va">groups_to_draw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="va">data_draw</span>, <span class="va">data_draw</span><span class="op">$</span><span class="va">group</span><span class="op">)</span>
  <span class="va">group_xsplines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">groups_to_draw</span>,
                           <span class="fu">ggalluvial</span><span class="fu">:::</span><span class="va">data_to_xspline</span>,
                           knot.prop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> 
  
  <span class="co"># Convert xspline coordinates to grid object.</span>
  <span class="va">xspline_coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
    <span class="va">group_xsplines</span>, 
    <span class="kw">function</span><span class="op">(</span><span class="va">coords</span><span class="op">)</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.xspline.html">xsplineGrob</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">coords</span><span class="op">$</span><span class="va">x</span>, 
                                       y<span class="op">=</span><span class="va">coords</span><span class="op">$</span><span class="va">y</span>, 
                                       shape<span class="op">=</span><span class="va">coords</span><span class="op">$</span><span class="va">shape</span>, 
                                       open<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
  <span class="op">)</span>
  
  <span class="co"># Use grid::xsplinePoints to draw the curve for each polygon</span>
  <span class="va">xspline_points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">xspline_coords</span>, <span class="fu">grid</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/grid/xsplinePoints.html">xsplinePoints</a></span><span class="op">)</span></code></pre></div>
<p>The coordinates we have are in grid plotting units but we need to convert them into the same units as the axes on the plot. We do this by determining the range of the x and y axes in grid units (<code>xrange_old</code> and <code>yrange_old</code>), then fixing the range of the x axis as 1 to the number of strata, adjusted by the width of the nodes, and the y axis to the number of rows in the data (again, this is possible here because each flow polygon is exactly 1 unit high).</p>
<p>We define a function <code>new_range_transform()</code> inline and apply it to each set of coordinates, assigning the resulting object globally so it can be accessed later. Now we have the coordinates of the polygons in plot units! So we can close the expression after returning the plot.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the x and y axis limits in grid coordinates (old) and plot</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># coordinates (new)</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  xrange_old <span class="ot">&lt;-</span> <span class="fu">range</span>(<span class="fu">unlist</span>(<span class="fu">lapply</span>(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    xspline_points,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(pts) <span class="fu">as.numeric</span>(pts<span class="sc">$</span>x)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  )))</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  yrange_old <span class="ot">&lt;-</span> <span class="fu">range</span>(<span class="fu">unlist</span>(<span class="fu">lapply</span>(</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    xspline_points, <span class="cf">function</span>(pts) <span class="fu">as.numeric</span>(pts<span class="sc">$</span>y)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  )))</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  xrange_new <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span> <span class="sc">-</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">6</span>, <span class="dv">3</span> <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">6</span>) </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  yrange_new <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(example_data)) </span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define function to convert grid graphics coordinates to data coordinates</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  new_range_transform <span class="ot">&lt;-</span> <span class="cf">function</span>(x_old, range_old, range_new) {</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    (x_old <span class="sc">-</span> range_old[<span class="dv">1</span>])<span class="sc">/</span>(range_old[<span class="dv">2</span>] <span class="sc">-</span> range_old[<span class="dv">1</span>]) <span class="sc">*</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>      (range_new[<span class="dv">2</span>] <span class="sc">-</span> range_new[<span class="dv">1</span>]) <span class="sc">+</span> range_new[<span class="dv">1</span>]</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Using the x and y limits, convert the grid coordinates into plot</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># coordinates. Use global assignment.</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  polygon_coords <span class="ot">&lt;&lt;-</span> <span class="fu">lapply</span>(xspline_points, <span class="cf">function</span>(pts) {</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    x_trans <span class="ot">&lt;-</span> <span class="fu">new_range_transform</span>(<span class="at">x_old =</span> <span class="fu">as.numeric</span>(pts<span class="sc">$</span>x), </span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">range_old =</span> xrange_old, </span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">range_new =</span> xrange_new)</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    y_trans <span class="ot">&lt;-</span> <span class="fu">new_range_transform</span>(<span class="at">x_old =</span> <span class="fu">as.numeric</span>(pts<span class="sc">$</span>y), </span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">range_old =</span> yrange_old, </span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">range_new =</span> yrange_new)</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">x =</span> x_trans, <span class="at">y =</span> y_trans)</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return plot</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>  p</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a><span class="er">}</span>, </span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> <span class="dv">200</span><span class="er">)</span></span></code></pre></div>
</div>
<div id="logic-for-determining-cursor-location-and-displaying-tooltips" class="section level4">
<h4 class="hasAnchor">
<a href="#logic-for-determining-cursor-location-and-displaying-tooltips" class="anchor"></a>2. Logic for determining cursor location and displaying tooltips</h4>
<p>First, we check whether the cursor is inside the plot panel. If it is not, the element <code>plot_hover</code> of the input will be <code>NULL</code>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>output<span class="sc">$</span>tooltip <span class="ot">&lt;-</span> <span class="fu">renderText</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(input<span class="sc">$</span>plot_hover)) { ... }</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Next, we check whether the cursor is over a stratum. We round the x-coordinate of the mouse cursor in data units to the nearest integer, then determine whether the x-coordinate is within <code>node_width/2</code> of that integer. If so, the mouse cursor is horizontally within the box.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hover</span> <span class="op">&lt;-</span> <span class="va">input</span><span class="op">$</span><span class="va">plot_hover</span>
<span class="va">x_coord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">hover</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>
    
<span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">hover</span><span class="op">$</span><span class="va">x</span> <span class="op">-</span> <span class="va">x_coord</span><span class="op">)</span> <span class="op">&lt;</span> <span class="op">(</span><span class="va">node_width</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="va">...</span> <span class="op">}</span></code></pre></div>
<p>The nearest integer to the y-coordinate corresponds to the row of the data frame because we set <code>reverse = TRUE</code> and all <code>weight = 1</code> in the input data. So, for example, the first row of the data frame corresponds to y range <code><a href="https://rdrr.io/r/base/c.html">c(0, 1)</a></code>, the second <code><a href="https://rdrr.io/r/base/c.html">c(1, 2)</a></code>, and so forth. This gives us all the information we need to find the index of the rows of the input data that goes with the stratum the cursor is on. <em>Note:</em> It is necessary for the input data to be sorted in ascending order of the <code>group</code> column, named <code>cluster</code> in this example. If it is not sorted in this way, the relative order of the flows along the y-axis will not correspond to their order in the data.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">node_row</span> <span class="op">&lt;-</span> 
  <span class="va">pbuilt</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">x</span> <span class="op">==</span> <span class="va">x_coord</span> <span class="op">&amp;</span> <span class="va">hover</span><span class="op">$</span><span class="va">y</span> <span class="op">&gt;</span> <span class="va">pbuilt</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">ymin</span> <span class="op">&amp;</span> <span class="va">hover</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;</span> <span class="va">pbuilt</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">ymax</span></code></pre></div>
<p>We get the name of the stratum as well as the total number of flows passing through it.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">node_label</span> <span class="op">&lt;-</span> <span class="va">pbuilt</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">stratum</span><span class="op">[</span><span class="va">node_row</span><span class="op">]</span>
<span class="va">node_n</span> <span class="op">&lt;-</span> <span class="va">pbuilt</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">n</span><span class="op">[</span><span class="va">node_row</span><span class="op">]</span></code></pre></div>
<p>Finally, we render a tooltip using the <code>div</code> tag and passing it to <code><a href="https://rdrr.io/pkg/htmltools/man/renderTags.html">htmltools::renderTags()</a></code>. Note that the tooltip positioning is provided in CSS coordinates (pixels), not data coordinates. This does not require any additional effort on our part because <code>plot_hover</code> also includes the mouse cursor location in those units.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">renderTags</span><span class="op">(</span>
  <span class="va">tags</span><span class="op">$</span><span class="fu">div</span><span class="op">(</span>
    <span class="va">node_label</span>, <span class="va">tags</span><span class="op">$</span><span class="fu">br</span><span class="op">(</span><span class="op">)</span>,
    <span class="st">"n ="</span>, <span class="va">node_n</span>,
    style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
      <span class="st">"position: absolute; "</span>,
      <span class="st">"top: "</span>, <span class="va">hover</span><span class="op">$</span><span class="va">coords_css</span><span class="op">$</span><span class="va">y</span> <span class="op">+</span> <span class="va">offset</span>, <span class="st">"px; "</span>,
      <span class="st">"left: "</span>, <span class="va">hover</span><span class="op">$</span><span class="va">coords_css</span><span class="op">$</span><span class="va">x</span> <span class="op">+</span> <span class="va">offset</span>, <span class="st">"px; "</span>,
      <span class="st">"background: gray; "</span>,
      <span class="st">"padding: 3px; "</span>,
      <span class="st">"color: white; "</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span><span class="op">$</span><span class="va">html</span></code></pre></div>
<p>If the cursor is not over a stratum, the next logic checks whether it is over an alluvium. This is done using the function <code><a href="https://rdrr.io/pkg/sp/man/point.in.polygon.html">sp::point.in.polygon</a></code> applied across each of the polygons for which we defined the coordinates inside the <code>renderPlot</code> expression.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hover_within_flow</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span>
  <span class="va">polygon_coords</span>,
  <span class="kw">function</span><span class="op">(</span><span class="va">pol</span><span class="op">)</span> <span class="fu">point.in.polygon</span><span class="op">(</span>point.x <span class="op">=</span> <span class="va">hover</span><span class="op">$</span><span class="va">x</span>, 
                                 point.y <span class="op">=</span> <span class="va">hover</span><span class="op">$</span><span class="va">y</span>, 
                                 pol.x <span class="op">=</span> <span class="va">pol</span><span class="op">$</span><span class="va">x</span>, 
                                 pol.y <span class="op">=</span> <span class="va">pol</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>If at least one polygon is beneath the mouse cursor, we locate the corresponding row in the input data and extract information to display in the tooltip. In the situation where there are more than one polygon overlapping, we get the information for the polygon that is plotted last by calling <code><a href="https://rdrr.io/r/base/rev.html">rev()</a></code> on the logical vector returned by <code><a href="https://rdrr.io/pkg/sp/man/point.in.polygon.html">point.in.polygon()</a></code>. This means that the tooltip will display information from the alluvium that appears “on top” in the plot. In this example, we will display the names of all the nodes that the alluvium passes through.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">coord_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">hover_within_flow</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
<span class="va">flow_id</span> <span class="op">&lt;-</span> <span class="va">example_data</span><span class="op">$</span><span class="va">ID</span><span class="op">[</span><span class="va">coord_id</span><span class="op">]</span>
<span class="va">axis_values</span> <span class="op">&lt;-</span> <span class="va">example_data</span><span class="op">[</span><span class="va">flow_id</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'grp1'</span>, <span class="st">'grp2'</span>, <span class="st">'grp3'</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<p>We render a tooltip that shows the names of all the nodes that the hovered path passes through, using very similar syntax to the above tooltip.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">renderTags</span><span class="op">(</span>
  <span class="va">tags</span><span class="op">$</span><span class="fu">div</span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">axis_values</span>, collapse <span class="op">=</span> <span class="st">' -&gt; '</span><span class="op">)</span>,
    style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
      <span class="st">"position: absolute; "</span>,
      <span class="st">"top: "</span>, <span class="va">hover</span><span class="op">$</span><span class="va">coords_css</span><span class="op">$</span><span class="va">y</span> <span class="op">+</span> <span class="va">offset</span>, <span class="st">"px; "</span>,
      <span class="st">"left: "</span>, <span class="va">hover</span><span class="op">$</span><span class="va">coords_css</span><span class="op">$</span><span class="va">x</span> <span class="op">+</span> <span class="va">offset</span>, <span class="st">"px; "</span>,
      <span class="st">"background: gray; "</span>,
      <span class="st">"padding: 3px; "</span>,
      <span class="st">"color: white; "</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span><span class="op">$</span><span class="va">html</span></code></pre></div>
</div>
</div>
</div>
<div id="conclusion" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h2>
<p>This vignette demonstrates how to enable tooltips for <strong>ggalluvial</strong> plots in Shiny apps. However it’s important to note that some of the workarounds are slightly inelegant. This may not be the optimal way to do it — other solutions are certainly possible!</p>
</div>
<div id="appendix" class="section level2">
<h2 class="hasAnchor">
<a href="#appendix" class="anchor"></a>Appendix</h2>
<div id="complete-app-code" class="section level3">
<h3 class="hasAnchor">
<a href="#complete-app-code" class="anchor"></a>Complete app code</h3>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://corybrunson.github.io/ggalluvial/">ggalluvial</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://shiny.rstudio.com">shiny</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/htmltools">htmltools</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edzer/sp/">sp</a></span><span class="op">)</span>

<span class="va">example_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  weight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">12</span><span class="op">)</span>,
  ID <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">12</span>,
  cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span>,
  grp1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'1a'</span>, <span class="st">'1b'</span>, <span class="st">'1a'</span>, <span class="st">'1b'</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,
  grp2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'2a'</span>, <span class="st">'2b'</span>, <span class="st">'2a'</span>, <span class="st">'2b'</span>, <span class="st">'2a'</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,
  grp3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'3a'</span>,<span class="st">'3b'</span>, <span class="st">'3a'</span>, <span class="st">'3b'</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># User interface</span>
<span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/fluidPage.html">fluidPage</a></span><span class="op">(</span>
  <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/fluidPage.html">fluidRow</a></span><span class="op">(</span><span class="va">tags</span><span class="op">$</span><span class="fu">div</span><span class="op">(</span>
    style <span class="op">=</span> <span class="st">"position: relative;"</span>,
    <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/plotOutput.html">plotOutput</a></span><span class="op">(</span><span class="st">"alluvial_plot"</span>, height <span class="op">=</span> <span class="st">"500px"</span>, 
               hover <span class="op">=</span> <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/hoverOpts.html">hoverOpts</a></span><span class="op">(</span>id <span class="op">=</span> <span class="st">"plot_hover"</span><span class="op">)</span>
    <span class="op">)</span>,
    <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/htmlOutput.html">htmlOutput</a></span><span class="op">(</span><span class="st">"tooltip"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="co"># Draw plot and extract coordinates</span>
  <span class="va">output</span><span class="op">$</span><span class="va">alluvial_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/renderPlot.html">renderPlot</a></span><span class="op">(</span><span class="op">{</span>
   
    <span class="co"># Width of node boxes</span>
    <span class="va">node_width</span> <span class="op">&lt;&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">4</span>
    
    <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">example_data</span>,
                <span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">weight</span>, axis1 <span class="op">=</span> <span class="va">grp1</span>, axis2 <span class="op">=</span> <span class="va">grp2</span>, axis3 <span class="op">=</span> <span class="va">grp3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
      <span class="fu"><a href="../reference/geom_alluvium.html">geom_alluvium</a></span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span>, knot.pos <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> 
      <span class="fu"><a href="../reference/geom_stratum.html">geom_stratum</a></span><span class="op">(</span>width <span class="op">=</span> <span class="va">node_width</span>, reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> 
      <span class="fu">geom_text</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="fu">after_stat</span><span class="op">(</span><span class="va">stratum</span><span class="op">)</span><span class="op">)</span>, 
                stat <span class="op">=</span> <span class="st">"stratum"</span>, 
                reverse <span class="op">=</span> <span class="cn">TRUE</span>, 
                size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
      <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu">scale_x_continuous</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu">scale_y_continuous</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>
    
    <span class="co"># Build the plot. Use global assignment so that this object is accessible</span>
    <span class="co"># later.</span>
    <span class="va">pbuilt</span> <span class="op">&lt;&lt;-</span> <span class="fu">ggplot_build</span><span class="op">(</span><span class="va">p</span><span class="op">)</span>
    
    <span class="co"># Use built plot data to recalculate the locations of the flow polygons:</span>
    
    <span class="co"># Add width parameter, and then convert built plot data to xsplines</span>
    <span class="va">data_draw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html">transform</a></span><span class="op">(</span><span class="va">pbuilt</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, width <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span>
    <span class="va">groups_to_draw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="va">data_draw</span>, <span class="va">data_draw</span><span class="op">$</span><span class="va">group</span><span class="op">)</span>
    <span class="va">group_xsplines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">groups_to_draw</span>,
                             <span class="fu">ggalluvial</span><span class="fu">:::</span><span class="va">data_to_xspline</span>,
                             knot.prop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> 
    
    <span class="co"># Convert xspline coordinates to grid object.</span>
    <span class="va">xspline_coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
      <span class="va">group_xsplines</span>,
      <span class="kw">function</span><span class="op">(</span><span class="va">coords</span><span class="op">)</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.xspline.html">xsplineGrob</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">coords</span><span class="op">$</span><span class="va">x</span>, 
                                         y <span class="op">=</span> <span class="va">coords</span><span class="op">$</span><span class="va">y</span>, 
                                         shape <span class="op">=</span> <span class="va">coords</span><span class="op">$</span><span class="va">shape</span>, 
                                         open <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
    <span class="op">)</span>
    
    <span class="co"># Use grid::xsplinePoints to draw the curve for each polygon</span>
    <span class="va">xspline_points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">xspline_coords</span>, <span class="fu">grid</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/grid/xsplinePoints.html">xsplinePoints</a></span><span class="op">)</span>
    
    <span class="co"># Define the x and y axis limits in grid coordinates (old) and plot</span>
    <span class="co"># coordinates (new)</span>
    <span class="va">xrange_old</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
      <span class="va">xspline_points</span>,
      <span class="kw">function</span><span class="op">(</span><span class="va">pts</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">pts</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>
    <span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">yrange_old</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
      <span class="va">xspline_points</span>,
      <span class="kw">function</span><span class="op">(</span><span class="va">pts</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">pts</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>
    <span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">xrange_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">6</span>, <span class="fl">3</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">6</span><span class="op">)</span> 
    <span class="va">yrange_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">example_data</span><span class="op">)</span><span class="op">)</span> 
    
    <span class="co"># Define function to convert grid graphics coordinates to data coordinates</span>
    <span class="va">new_range_transform</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x_old</span>, <span class="va">range_old</span>, <span class="va">range_new</span><span class="op">)</span> <span class="op">{</span>
      <span class="op">(</span><span class="va">x_old</span> <span class="op">-</span> <span class="va">range_old</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">range_old</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">range_old</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span>
        <span class="op">(</span><span class="va">range_new</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">range_new</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="va">range_new</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    <span class="op">}</span>
    
    <span class="co"># Using the x and y limits, convert the grid coordinates into plot</span>
    <span class="co"># coordinates. Use global assignment.</span>
    <span class="va">polygon_coords</span> <span class="op">&lt;&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">xspline_points</span>, <span class="kw">function</span><span class="op">(</span><span class="va">pts</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">x_trans</span> <span class="op">&lt;-</span> <span class="fu">new_range_transform</span><span class="op">(</span>x_old <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">pts</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>, 
                                     range_old <span class="op">=</span> <span class="va">xrange_old</span>, 
                                     range_new <span class="op">=</span> <span class="va">xrange_new</span><span class="op">)</span>
      <span class="va">y_trans</span> <span class="op">&lt;-</span> <span class="fu">new_range_transform</span><span class="op">(</span>x_old <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">pts</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>, 
                                     range_old <span class="op">=</span> <span class="va">yrange_old</span>, 
                                     range_new <span class="op">=</span> <span class="va">yrange_new</span><span class="op">)</span>
      <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_trans</span>, y <span class="op">=</span> <span class="va">y_trans</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>

    <span class="co"># Return plot</span>
    <span class="va">p</span>
  <span class="op">}</span>, 
  res <span class="op">=</span> <span class="fl">200</span><span class="op">)</span>
  
  <span class="va">output</span><span class="op">$</span><span class="va">tooltip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/renderText.html">renderText</a></span><span class="op">(</span>
    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">plot_hover</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">hover</span> <span class="op">&lt;-</span> <span class="va">input</span><span class="op">$</span><span class="va">plot_hover</span>
      <span class="va">x_coord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">hover</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>
      
      <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">hover</span><span class="op">$</span><span class="va">x</span> <span class="op">-</span> <span class="va">x_coord</span><span class="op">)</span> <span class="op">&lt;</span> <span class="op">(</span><span class="va">node_width</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
        <span class="co"># Display node information if cursor is over a stratum box.</span>

        <span class="co"># Determine stratum name from x and y coord, and the n.</span>
        <span class="va">node_row</span> <span class="op">&lt;-</span> <span class="va">pbuilt</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">x</span> <span class="op">==</span> <span class="va">x_coord</span> <span class="op">&amp;</span> 
                    <span class="va">hover</span><span class="op">$</span><span class="va">y</span> <span class="op">&gt;</span> <span class="va">pbuilt</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">ymin</span> <span class="op">&amp;</span> 
                    <span class="va">hover</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;</span> <span class="va">pbuilt</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">ymax</span>
        <span class="va">node_label</span> <span class="op">&lt;-</span> <span class="va">pbuilt</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">stratum</span><span class="op">[</span><span class="va">node_row</span><span class="op">]</span>
        <span class="va">node_n</span> <span class="op">&lt;-</span> <span class="va">pbuilt</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">n</span><span class="op">[</span><span class="va">node_row</span><span class="op">]</span>
        
        <span class="co"># Offset, in pixels, for location of tooltip relative to mouse cursor,</span>
        <span class="co"># in both x and y direction.</span>
        <span class="va">offset</span> <span class="op">&lt;-</span> <span class="fl">5</span>
        
        <span class="co"># Render tooltip</span>
        <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/renderTags.html">renderTags</a></span><span class="op">(</span>
          <span class="va">tags</span><span class="op">$</span><span class="fu">div</span><span class="op">(</span>
            <span class="va">node_label</span>, <span class="va">tags</span><span class="op">$</span><span class="fu">br</span><span class="op">(</span><span class="op">)</span>,
            <span class="st">"n ="</span>, <span class="va">node_n</span>,
            style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
              <span class="st">"position: absolute; "</span>,
              <span class="st">"top: "</span>, <span class="va">hover</span><span class="op">$</span><span class="va">coords_css</span><span class="op">$</span><span class="va">y</span> <span class="op">+</span> <span class="va">offset</span>, <span class="st">"px; "</span>,
              <span class="st">"left: "</span>, <span class="va">hover</span><span class="op">$</span><span class="va">coords_css</span><span class="op">$</span><span class="va">x</span> <span class="op">+</span> <span class="va">offset</span>, <span class="st">"px; "</span>,
              <span class="st">"background: gray; "</span>,
              <span class="st">"padding: 3px; "</span>,
              <span class="st">"color: white; "</span>
            <span class="op">)</span>
          <span class="op">)</span>
        <span class="op">)</span><span class="op">$</span><span class="va">html</span>
      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
        <span class="co"># Display flow information if cursor is over a flow polygon: what</span>
        <span class="co"># alluvia does it pass through?</span>
        
        <span class="co"># Calculate whether coordinates of hovering cursor are inside one of the</span>
        <span class="co"># polygons.</span>
        <span class="va">hover_within_flow</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span>
          <span class="va">polygon_coords</span>,
          <span class="kw">function</span><span class="op">(</span><span class="va">pol</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/point.in.polygon.html">point.in.polygon</a></span><span class="op">(</span>point.x <span class="op">=</span> <span class="va">hover</span><span class="op">$</span><span class="va">x</span>, 
                                         point.y <span class="op">=</span> <span class="va">hover</span><span class="op">$</span><span class="va">y</span>, 
                                         pol.x <span class="op">=</span> <span class="va">pol</span><span class="op">$</span><span class="va">x</span>, 
                                         pol.y <span class="op">=</span> <span class="va">pol</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>
        <span class="op">)</span>
        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">hover_within_flow</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
          <span class="co"># Find the alluvium that is plotted on top. (last)</span>
          <span class="va">coord_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">hover_within_flow</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
          <span class="co"># Get the corresponding row ID from the data.</span>
          <span class="va">flow_id</span> <span class="op">&lt;-</span> <span class="va">example_data</span><span class="op">$</span><span class="va">ID</span><span class="op">[</span><span class="va">coord_id</span><span class="op">]</span>
          <span class="co"># Get the axis 1-3 values for all axes for that row ID.</span>
          <span class="va">axis_values</span> <span class="op">&lt;-</span> <span class="va">example_data</span><span class="op">[</span><span class="va">flow_id</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'grp1'</span>, <span class="st">'grp2'</span>, <span class="st">'grp3'</span><span class="op">)</span><span class="op">]</span>
          
          <span class="va">offset</span> <span class="op">&lt;-</span> <span class="fl">5</span>
          
          <span class="co"># Render tooltip</span>
          <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/renderTags.html">renderTags</a></span><span class="op">(</span>
            <span class="va">tags</span><span class="op">$</span><span class="fu">div</span><span class="op">(</span>
              <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">axis_values</span>, collapse <span class="op">=</span> <span class="st">' -&gt; '</span><span class="op">)</span>,
              style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
                <span class="st">"position: absolute; "</span>,
                <span class="st">"top: "</span>, <span class="va">hover</span><span class="op">$</span><span class="va">coords_css</span><span class="op">$</span><span class="va">y</span> <span class="op">+</span> <span class="va">offset</span>, <span class="st">"px; "</span>,
                <span class="st">"left: "</span>, <span class="va">hover</span><span class="op">$</span><span class="va">coords_css</span><span class="op">$</span><span class="va">x</span> <span class="op">+</span> <span class="va">offset</span>, <span class="st">"px; "</span>,
                <span class="st">"background: gray; "</span>,
                <span class="st">"padding: 3px; "</span>,
                <span class="st">"color: white; "</span>
              <span class="op">)</span>
            <span class="op">)</span>
          <span class="op">)</span><span class="op">$</span><span class="va">html</span>
        <span class="op">}</span>
      <span class="op">}</span>
    <span class="op">}</span>
  <span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/shinyApp.html">shinyApp</a></span><span class="op">(</span>ui <span class="op">=</span> <span class="va">ui</span>, server <span class="op">=</span> <span class="va">server</span><span class="op">)</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jason Cory Brunson, Quentin D. Read.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
