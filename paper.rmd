---
title: "ggalluvial: Layered Grammar for Alluvial Plots"
tags:
  - R
  - ggplot2
  - alluvial plots
  - statistical graphics
  - data visualization
  - repeated measures data
  - categorical data
authors:
  - name: Jason Cory Brunson
    orcid: 0000-0003-3126-9494
    affiliation: "1"
affiliations:
 - name: Center for Quantitative Medicine, UConn Health
   index: 1
date: 2019-12-05
bibliography: paper.bib
output: md_document
---

<!--
To generate `paper.md`, execute this from the console:
```r
knitr::knit("paper.rmd", "paper.md")
```
-->

```{r, echo=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "paper/"
)
```

# Summary

Alluvial diagrams use stacked bar plots and variable-width ribbons to represent multi-dimensional or repeated-measures data comprising categorical or ordinal variables [@Rosvall2010;@Bojanowski2016]. The ggalluvial package extends the layered grammar of graphics of ggplot2 [@Wickham2016] to generate alluvial diagrams from tidy data [@Wickham2014].
The package makes two key contributions to the R ecosystem, which i summarize here and discuss in more detail below.

First, ggalluvial anchors the imprecise notion of an alluvial diagram to the rigid grammar of graphics [@Wilkinson2006], which imbues the resulting plots with greater meaning, most notably a cumulative axis, and imparts many combinatorial possibilities, e.g. with the text and point--line geoms of ggplot2. Meanwhile, the package gives users a high degree of control over underlying data transformations, and thereby over the messages conveyed in the plot, whereas other extensions are not so flexible.[^easy] The package also integrates alluvial plots to a tidyverse workflow [@Wickham2019] by recognizing two common tidy data formats and exporting data transformation functions that follow tidyr and dplyr conventions.

Second, ggalluvial cements some concepts and terms that are inconsistently applied by developers and users of Sankey, parallel sets, and alluvial diagrams.
For example, the diagrams that came to be known as parallel sets plots [@Kosara2006] were anticipated in the "start-up state" of an interactive generator of Sankey diagrams [@Riehmann2005], using wholly different terms for their graphical elements.
Since alluvial diagrams were introduced, implementations and applications have borrowed terminology from both previous diagram types. Instead, ggalluvial adopts a distinctive, geological nomenclature for its graphical elements. While this risks exacerbating confusion, the "alluvial plots" described here are, i think, distinctive enough from Sankey diagrams and parallel sets plots to warrant it. I hope that these conventions can serve as useful points of reference as these visualization tools converge toward common standards.

[^easy]: Indeed, the dependency package easyalluvial [@Koneswarakantha2019] was built on top of ggalluvial to exchange much of this flexibility for expedited data exploration using alluvial plots.

## Functionality

[The titular vignette](http://corybrunson.github.io/ggalluvial/articles/ggalluvial.html) thoroughly describes and illustrates the functionality of ggalluvial, and the reader is encouraged to browse [the package documentation](http://corybrunson.github.io/ggalluvial/reference/index.html) for more thorough illustrations. In brief, the package contains stat and geom functions to add the following layers to a ggplot2 object:

* _strata_, or stacked bar plots, located at each of multiple horizontal positions (_axes_ or _dimensions_)
* _alluvia_, ribbons through strata at different axes that encode individual cases or cohorts measured along each axis
* _lodes_, subdivisions of strata by their intersections with alluvia
* _flows_, segments of alluvia between adjacent axes (excluding lodes)

The layers of a ggplot2 graphic are formed by pairing stats (statistical transformations of the input data) with geoms (geometric mappings from the transformed data); while every stat and geom has a conventional default, alternative pairings are the primary source of combinatorial richness for this layered grammar.
The following alluvial plot depicts several meaningful stat--geom combinations that appear in the documentation. Default pairings, other within-package ("alluvial") pairings, and pairings of alluvial stats with other geoms are differentiated by `fill` color:

```{r figure, echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width=6}
library(ggalluvial)
combos <- data.frame(
  stat = c(
    rep("stratum", 2),
    rep("alluvium", 4),
    "flow",
    # text geom
    c("stratum", "alluvium", "flow"),
    # errorbar and pointrange geoms
    "stratum", "alluvium", "flow"
  ),
  geom = c(
    c("stratum", "lode"),
    c("stratum", "alluvium", "lode", "flow"),
    "flow",
    rep("text", 3),
    "errorbar", "pointrange", "pointrange"
  ),
  pairing = c(
    c("default", "alluvial"),
    c("alluvial", "default", "default", "alluvial"),
    "default",
    rep("external", 6)
  )
)
levs <- c("stratum", "alluvium", "lode", "flow",
          "text", "errorbar", "pointrange")
combos <- transform(
  combos,
  stat = factor(stat, levs),
  geom = factor(geom, levs),
  pairing = factor(pairing, c("default", "alluvial", "external"))
)
ggplot(combos, aes(axis1 = stat, axis2 = geom)) +
  scale_x_discrete(limits = c("stat", "geom"), expand = c(.1, .05)) +
  geom_alluvium(aes(fill = pairing)) +
  scale_fill_brewer(type = "qual") +
  geom_stratum() +
  geom_text(stat = "stratum", infer.label = TRUE) +
  theme_minimal()
```

The alluvial stats require custom aesthetics---either `stratum` and/or `alluvium` in combination with `x`, if the data are in long format, or some number of axis specifications (`axis1`, `axis2`, etc.), if the data are in wide format. Because these aesthetics are not recognized by ggplot2, they produce warnings under some conditions. The long (one row per lode) and wide (one row per alluvium) formats are also detailed in the vignette, and are related to each other by the pivot operations of tidyr. Because the alluvial geoms are highly specialized to these stats, no pairings with outside stats are currently supported.

Most of the stat parameters control how the strata at each axis, and the lodes within each stratum, are ordered vertically. By default, these orderings are independent of differentiation aesthetics, so that layers are consistent within and across plots unless otherwise specified. [An auxiliary vignette](http://corybrunson.github.io/ggalluvial/articles/order-rectangles.html) details the effects of each of these parameters. For convenience, they can also be set as global options.

While questions and requests by users have prompted improvements throughout ggalluvial's development, the current version is expected to be feature complete, with one exception: alternative curves will be implemented for the `alluvium` and `flow` geoms, controlled by a new parameter. The current splines will remain the default, so that the output of existing code will not change. This is expected to be the last change before version `1.0`.

## Concepts

Statistical graphics of multivariate categorical data tend to take one of two forms: ordinations of continuous-valued transformations (e.g. residual plots from multiple regression; ternary plots from tripartition data; biplots from correspondence analysis and factor analysis) and arrangements of length- or area-encoded shapes (e.g. mosaic plots [@Friendly2002]; product plots [@Wickham2011]; stacked area charts).
In particular, parallel sets plots, adapted from parallel coordinates plots [@Inselberg1987;@Wegman1990], represent cohorts of equivalent cases as ribbons connecting categories represented as boxes [@Kosara2006].

Meanwhile, visualizations of flow processes have long encoded magnitudes, such as volumes and counts, as ribbon widths, and this broad genre have come to be called Sankey diagrams [@Schmidt2008]; see <http://www.sankey-diagrams.com/> for many examples.
A widely-used and -implemented subtype of Sankey diagram encodes longitudinal categorical data as rectangular nodes, representing categories, threaded by ribbons that encode the trajectories and magnitudes of cases [@Riehmann2005].

Most recently, @Rosvall2010 proposed "alluvial diagrams" to visualize changes in cluster membership among cases over successive cross-sections, with cohorts of equivalent cases encoded as ribbons intersecting stacked bar plots at each time point. These diagrams have since been used to represent a wide range of discrete-valued data, over repeated measures or multiple dimensions.

Several R packages, including ggplot2 extensions, have been developed to generate these types of data visualizations. Here are the most relevant for this discussion:

- alluvial for alluvial diagrams in base R [@Bojanowski2016]
- ggforce for parallel sets plots in ggplot2 [@Pedersen2019]
- ggparallel and ggpcp for parallel sets, hammock, and common angle plots in ggplot2 [@Hofmann2013;@Ge2019]
- ggalluvial for alluvial diagrams in ggplot2 [@Brunson2019]

While Sankey diagrams, parallel sets plots, and alluvial diagrams have accrued their own characteristic use cases, the terms are often used interchangeably, and there is currently no consensus on what features, if any, are distinctive to each type. Moreover, these visualization techniques in practice vary widely in their flexibility or rigidity---some rely on non-deterministic layout algorithms and can even be interactively manipulated, while others are wholly determined by the data; most give the user limited control through parameter settings.

The diagrams produced by ggalluvial are statistical graphics in the sense that they communicate statistical information using graphical methods [@Friendly2005] and, more narrowly, are uniquely determined from data by a fixed set of plotting rules [@Wilkinson2006]. The package adopts for them the less common term _alluvial plot_.[^plots]
These plots are distinct from Sankey diagrams (they exhibit a much narrower range of behavior, e.g. no cycles, and do not necessarily represent flow) and constitute a subtype of parallel sets plots distinguished by two features: a strict order on the stacked elements at each axis, including both the values of the discrete variables and the ribbons connecting cases or cohorts between them; and a meaningful positional dimension along which these elements are stacked, which precludes inserting gaps between them (as is typical of most diagrams of each type), features shared only by ggparallel. The plot elements (strata, either alluvia or flows, and optionally lodes or others as discussed above) are rendered a separate layers, following the additive (`+`) syntax of ggplot2, a feature shared only by ggpcp.

[^plots]: This has the unfortunate side effect of conflating search results from the geology literature.

## Applications

ggalluvial has seen widespread use in research and scholarship.
While many of these uses would be served equally well by other parallel sets plots or Sankey diagrams, i showcase here three settings to which alluvial plots seem exceptionally well-suited: repeated ordinal measures data, incomplete longitudinal data, and signed categorical data.
To be sure, this is a subjective assessment that may be refuted by visualization effectiveness research.

**Repeated ordinal measures data:**
Parallel sets plots and Sankey diagrams are commonly used to represent repeated categorical measures data. Most implementations stack each bar plot in order of name or of size, though some follow hierarchies provided by the user, often with vertical space between category for easy visual discrimination. In contrast, ordinal variables are more appropriately stacked in their own intrinsic and consistent order, and, when the number of categories changes from time to time, vertical separations can obscure whether the cases and cohorts changed in number as well. A use case by @Schlotter2019, to represent changes (or not) in patients' physical limitations following an investigational right heart valve repair technique, illustrates the use of an ordinal stratum variable (a heart failure functional classification). Another, by @North2019, to represent ranked preferences among several definitions of veganism by survey respondents, illustrates the importance of consistency in order across axes (in this case preference ranks rather than time points).

**Incomplete longitudinal data:**
Alluvial plots very clearly delineate times at which longitudinal data are censored, discontinued, or otherwise missing: Certain strata, or the alluvia or flows connecting them, are present at one time point but absent at a previous or future one.
@Seekatz2018 use this feature to include in one alluvial plot a sample of _Clostridium difficile_--infected (CDI) patients who had their infections ribotyped at multiple times. Patients were classified by dominant ribotype, and the alluvial plot showcased variability in this dominant type. While all 32 patients had at least two samples taken, only 3 had four, so that the bar plots shortened with each time point.
@Sjoding2019 use a similar plot to trace patient groups receiving mechanical ventilation based on discretized tidal volumes, including a grey stratum for patients discontinued from intubation rather than omitting them entirely from the plot.
<!--
Even in cases of intermediate missingness, when a case is lost, or its value diminished to zero, between two time points at which it is positively measured, alluvial diagrams can preserve the continuity of such cases by shrinking their ribbon widths to zero at the intermediate point. (See the example in the `stat_alluvium()` examples using the babynames package.)
-->

**Signed categorical data:**
@Edwards2019 recently produced a novel alluvial plot to represent changes in ownership category (owner-operated, corporate, etc.) of owners in a halibut fishery. Not only the categorical distribution but the total number of owners changed from year to year as exeters were not exactly matched by new entrants. In order to depict an accurate total but include both new entrants and exeters at each year, the authors affixed a negative stratum for the exeter category to each bar plot, below the horizontal axis. Such a feature has no analogue in Sankey diagrams or parallel sets plots (which do not commonly employ a cumulative axis) but potentially wide-ranging applications: Bar plots may include both "positive" and "negative" bars to represent definitionally negative groups, such as revenues versus deficits, or to contrast the bars divided along a binary variable such as gender across age groups in a population (so-called "pyramid plots"). Alluvial plots provide a way to track cases and cohorts across such bar plots, even when cases may change sign. Future use cases may demonstrate the practical utility of this functionality.

# Acknowledgments

I am grateful to many users for their feedback on every version of this package. Development benefitted from the use of resources and support of colleagues at UConn Health, and i have been supported in part by T90 training grant from the National Institute of Dental and Craniofacial Research (5T90DE021989-07).

# References
